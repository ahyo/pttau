{% extends "layouts/base.html" %}
{% block title %}Keranjang Belanja — {{ settings.APP_NAME }}{% endblock %}
{% block content %}
<section class="py-5 bg-light">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
      <div>
        <h1 class="h3 mb-1">Keranjang Belanja</h1>
        <p class="text-muted mb-0">Kelola pesanan Anda sebelum melanjutkan ke proses pembayaran.</p>
      </div>
      <a class="btn btn-outline-primary" href="/catalog">
        <i class="bi bi-arrow-left"></i> Lanjutkan Belanja
      </a>
    </div>

    {% if request.query_params.get('msg') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      {{ request.query_params.get('msg') }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if items %}
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Produk</th>
                  <th class="text-center">Harga</th>
                  <th class="text-center">Jumlah</th>
                  <th class="text-end">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for row in items %}
                {% set item = row.item %}
                {% set product = row.product %}
                {% set display_name = row.name or product.slug %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center gap-3">
                      <div class="ratio ratio-1x1" style="width: 64px;">
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" class="img-fluid rounded" alt="{{ display_name }}" />
                        {% else %}
                        <div class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center text-secondary fw-semibold">
                          {{ display_name[:1]|upper }}
                        </div>
                        {% endif %}
                      </div>
                      <div>
                        <div class="fw-semibold">{{ display_name }}</div>
                        <div class="text-muted small">/{{ product.slug }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="text-center">Rp {{ "{:,.2f}".format(product.price or 0) }}</td>
                  <td class="text-center">
                    <form method="post" action="/cart/update" class="d-inline-flex align-items-center gap-2 justify-content-center">
                      <input type="hidden" name="item_id" value="{{ item.id }}" />
                      <input type="number" name="quantity" min="1" class="form-control form-control-sm" style="width: 70px;" value="{{ item.quantity }}" />
                      <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                    </form>
                  </td>
                  <td class="text-end fw-semibold">Rp {{ "{:,.2f}".format(row.subtotal) }}</td>
                  <td class="text-center">
                    <form method="post" action="/cart/remove" onsubmit="return confirm('Hapus produk dari keranjang?');">
                      <input type="hidden" name="item_id" value="{{ item.id }}" />
                      <button type="submit" class="btn btn-sm btn-link text-danger">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h2 class="h5 mb-3">Ringkasan Pesanan</h2>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Subtotal</span>
              <span>Rp {{ "{:,.2f}".format(total) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-4">
              <span class="text-muted">Pajak & Pengiriman</span>
              <span>—</span>
            </div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-4">
              <span class="fw-semibold">Total</span>
              <span class="h4 text-primary mb-0">Rp {{ "{:,.2f}".format(total) }}</span>
            </div>
            <form method="post" action="/cart/checkout" class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-credit-card me-1"></i>Lanjutkan Pembayaran
              </button>
              <small class="text-muted">Tim kami akan menghubungi Anda untuk proses pembayaran selanjutnya.</small>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="card border-0 shadow-sm">
      <div class="card-body py-5 text-center">
        <i class="bi bi-cart3 display-5 text-muted"></i>
        <h3 class="mt-3">Keranjang masih kosong</h3>
        <p class="text-muted">Ayo jelajahi katalog kami dan tambahkan produk yang Anda inginkan.</p>
        <a class="btn btn-primary" href="/catalog">Ke Katalog Produk</a>
      </div>
    </div>
    {% endif %}
  </div>
</section>
{% endblock %}
